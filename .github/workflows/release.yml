name: Release

on:
  push:
    tags:
      - "*"

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5.2.0

      - name: Install dependencies
        run: |
          # Pin riot 0.0.5 from git (original tarball URL is broken)
          opam pin riot.0.0.5 https://github.com/riot-ml/riot.git#0.0.5 --yes
          opam install . --deps-only --yes

      - name: Build binary
        run: |
          opam exec -- dune build --profile=release

      - name: Prepare binary
        run: |
          cp _build/default/bin/main.exe pg
          chmod +x pg
          tar -czvf pg-macos-arm64.tar.gz pg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pg-macos-arm64
          path: pg-macos-arm64.tar.gz

  build-linux:
    runs-on: ubuntu-latest
    container:
      image: ocaml/opam:alpine-ocaml-5.2
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apk add --no-cache musl-dev gcc make m4 patch git gmp-dev gmp-static linux-headers pkgconfig

      - name: Setup opam
        run: |
          opam init --disable-sandboxing --bare -y || true
          opam switch create . ocaml-base-compiler.5.2.0 --no-install -y || opam switch . -y
          eval $(opam env)

      - name: Install dependencies
        run: |
          eval $(opam env)
          # Pin riot 0.0.5 from git (original tarball URL is broken)
          opam pin riot.0.0.5 https://github.com/riot-ml/riot.git#0.0.5 --yes
          opam install . --deps-only --yes

      - name: Build binary
        run: |
          eval $(opam env)
          # Build with release profile (musl-linked binaries are portable)
          dune build --profile=release

      - name: Verify binary
        run: |
          file _build/default/bin/main.exe
          ldd _build/default/bin/main.exe 2>&1 || echo "Binary info"

      - name: Prepare binary
        run: |
          cp _build/default/bin/main.exe pg
          chmod +x pg
          tar -czvf pg-linux-x86_64.tar.gz pg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pg-linux-x86_64
          path: pg-linux-x86_64.tar.gz

  release:
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: pg-macos-arm64

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: pg-linux-x86_64

      - name: Calculate checksums
        id: checksums
        run: |
          echo "MACOS_SHA=$(sha256sum pg-macos-arm64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_ENV"
          echo "LINUX_SHA=$(sha256sum pg-linux-x86_64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_ENV"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            pg-macos-arm64.tar.gz
            pg-linux-x86_64.tar.gz
          generate_release_notes: true

      - name: Clone Homebrew Repo
        run: |
          git clone https://aslak01:${{ secrets.TAP_GITHUB_TOKEN }}@github.com/aslak01/homebrew-stuff.git brew-stuff
          cd brew-stuff
          git checkout master

      - name: Update Homebrew Formula
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Strip 'v' prefix for version field (e.g., v2.1.2 -> 2.1.2)
          VERSION="${TAG#v}"
          echo "Building formula for tag: $TAG, version: $VERSION"
          echo "macOS checksum: $MACOS_SHA"
          mkdir -p ./brew-stuff/Formula

          # Main formula (always latest)
          cat > ./brew-stuff/Formula/pg.rb <<EOF
          class Pg < Formula
            desc "A TUI for searching torrents with vim-style navigation"
            homepage "https://github.com/aslak01/pg"
            version "${VERSION}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/aslak01/pg/releases/download/${TAG}/pg-macos-arm64.tar.gz"
                sha256 "$MACOS_SHA"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/aslak01/pg/releases/download/${TAG}/pg-linux-x86_64.tar.gz"
                sha256 "$LINUX_SHA"
              end
            end

            def install
              bin.install "pg"
            end
          end
          EOF

      - name: Push Brew formula
        run: |
          cd ./brew-stuff
          git add Formula/
          git config --local user.name github-actions
          git config --local user.email github-actions@github.com
          git commit -m "formula update pg ${GITHUB_REF#refs/tags/}" || echo "No changes to commit"
          git push origin master
